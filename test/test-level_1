'use strict';
global.DATABASE_URL = 'mongodb://localhost/jwt-auth-demo-test';
const chai = require('chai');
const chaiHttp = require('chai-http');

const { app, runServer, closeServer } = require('../server');
const { User } = require('../users');

const expect = chai.expect;

chai.use(chaiHttp);

describe('api/risk', function() {
    const year = 5;
    const currentFund = 6200;

    before(function() {
        return runServer();
    });

    after(function() {
        return closeServer();
    });

    beforeEach(function() {});

    afterEach(function() {
        return User.remove({});
    });

    describe('api/risk', function() {
        describe('POST', function() {
            it('Should reject requests with a missing body element', function() {
                return chai
                    .request(app)
                    .post('api/risk')
                    .send({
                        year,
                        currentFund
                    })
                    .then(() => expect.fail(null, null, 'Request should not succeed'))
                    .catch(err => {
                        if (err instanceof chai.asswertionError) {
                            throw err;
                        }
                        const res = err.response;
                        expect(res).to.have.status(422);
                        expect(res.body.reason).to.equal('ValidationError');
                        expect(res.body.message).to.equal('Missing field');
                        expect(res.body.location).to.equal('risk');
                    });
            });
        });
    });
});